<!DOCTYPE html>
<html>
  <head>
    <title>Test OAuth Fix</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
      }
      .success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .info {
        background-color: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
      button {
        padding: 10px 20px;
        margin: 5px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <h1>OAuth Fix Test</h1>
    <div id="status" class="info">Ready to test...</div>

    <button id="testClientId">Test Client ID Error Handling</button>
    <button id="testRevoke">Test Revoke Function</button>
    <button id="testOAuth">Test OAuth Flow</button>

    <div id="results"></div>

    <script>
      // Mock Chrome extension environment
      if (typeof chrome === "undefined") {
        window.chrome = {
          identity: {
            getAuthToken: (options, callback) => {
              console.log("Mock chrome.identity.getAuthToken called");
              // Simulate client ID error
              setTimeout(() => {
                chrome.runtime = {
                  lastError: {
                    message:
                      "OAuth2 request failed: Service responded with error: 'bad client id: {0}'",
                  },
                };
                callback(null);
              }, 1000);
            },
            removeCachedAuthToken: (options, callback) => {
              console.log("Mock chrome.identity.removeCachedAuthToken called");
              setTimeout(callback, 100);
            },
          },
          runtime: {
            lastError: null,
          },
        };
      }

      // Mock Google APIs
      window.google = {
        accounts: {
          oauth2: {
            initTokenClient: (config) => {
              console.log("Mock google.accounts.oauth2.initTokenClient called");
              return {
                requestAccessToken: (options) => {
                  console.log("Mock requestAccessToken called");
                  // Simulate error
                  setTimeout(() => {
                    config.callback({
                      access_token: null,
                      expires_in: 0,
                      scope: config.scope,
                      token_type: "Bearer",
                      error:
                        "OAuth2 request failed: Service responded with error: 'bad client id: {0}'",
                    });
                  }, 500);
                },
              };
            },
            revoke: undefined, // Simulate missing revoke function
          },
        },
      };

      // Test functions
      function updateStatus(message, type = "info") {
        const status = document.getElementById("status");
        status.textContent = message;
        status.className = `status ${type}`;
      }

      function addResult(message, type = "info") {
        const results = document.getElementById("results");
        const div = document.createElement("div");
        div.className = `status ${type}`;
        div.textContent = message;
        results.appendChild(div);
      }

      // Test Client ID Error Handling
      document.getElementById("testClientId").addEventListener("click", () => {
        updateStatus("Testing client ID error handling...", "info");

        // Simulate the error handling from our code
        const error =
          "OAuth2 request failed: Service responded with error: 'bad client id: {0}'";

        if (
          error.includes("bad client id") ||
          error.includes("Invalid OAuth2 Client ID")
        ) {
          addResult("‚úÖ Client ID error detected correctly", "success");
          addResult("üí° Error handling provides helpful guidance", "info");
        } else {
          addResult("‚ùå Client ID error not detected", "error");
        }
      });

      // Test Revoke Function
      document.getElementById("testRevoke").addEventListener("click", () => {
        updateStatus("Testing revoke function fallback...", "info");

        // Simulate the revoke function check from our code
        if (
          window.google &&
          window.google.accounts &&
          window.google.accounts.oauth2 &&
          typeof window.google.accounts.oauth2.revoke === "function"
        ) {
          addResult("‚ùå Revoke function should not be available", "error");
        } else {
          addResult(
            "‚úÖ Revoke function correctly detected as unavailable",
            "success"
          );
          addResult(
            "‚úÖ Fallback to Chrome identity API will be used",
            "success"
          );
        }
      });

      // Test OAuth Flow
      document.getElementById("testOAuth").addEventListener("click", () => {
        updateStatus("Testing OAuth flow...", "info");

        // Simulate the OAuth flow
        const config = {
          client_id: "test-client-id",
          scope: "test-scope",
          callback: (response) => {
            if (response.error) {
              addResult("‚úÖ OAuth error handled correctly", "success");
              addResult(`Error: ${response.error}`, "error");
            } else {
              addResult("‚ùå Expected OAuth error but got success", "error");
            }
          },
        };

        const tokenClient =
          window.google.accounts.oauth2.initTokenClient(config);
        tokenClient.requestAccessToken();
      });

      updateStatus(
        "OAuth fix test ready. Click buttons to test different scenarios.",
        "info"
      );
    </script>
  </body>
</html>
